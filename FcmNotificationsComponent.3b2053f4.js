"use strict";(self.webpackChunk_solflare_extension=self.webpackChunk_solflare_extension||[]).push([["FcmNotificationsComponent"],{"../../libs/shared/dist/components/FcmNotifications/index.js":function(e,t,i){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i("../../../node_modules/react/jsx-runtime.js"),o=i("../../../node_modules/react/index.js"),a=i("../../../node_modules/react-i18next/dist/es/index.js"),r=i("../../../node_modules/react-redux/es/index.js"),d=i("../../../node_modules/react-router-dom/esm/react-router-dom.js"),c=i("../../libs/foundation-ui/dist/index.js"),l=i("../../libs/shared/dist/constants/networks.js"),u=i("../../libs/shared/dist/features/notifications/index.js"),f=i("../../libs/shared/dist/features/settings/index.js"),p=i("../../libs/shared/dist/hooks/useMetamask/index.js"),g=s(i("../../libs/shared/dist/storage/solflareService.js")),b=i("../../libs/shared/dist/store/selectors/config.js"),m=i("../../libs/shared/dist/store/selectors/data.js"),h=i("../../libs/shared/dist/utils/extension.js"),N=i("../../libs/shared/dist/utils/notifications.js");t.default=()=>{const{t:e}=(0,a.useTranslation)(),t=(0,d.useHistory)();(0,u.useRegisterNotifications)();const i=(0,r.useSelector)(b.networkSelector),s=(0,r.useSelector)(m.notificationsDataSelector),[_,j]=(0,o.useState)(!1),{isMetamask:S}=(0,p.useMetamask)(),{setNotificationsEnabled:x}=(0,u.useSetNotificationsEnabled)({onDenied:()=>t.push(f.ROUTE.NOTIFICATIONS.HOME)}),I=(0,o.useCallback)((async()=>{let e=await g.default.solflareEnableNotificationsModal.get();null!==e?(e="true"===e?0:parseInt(e,10),(0===e||Date.now()>e+(0,N.bannerCooldown)())&&j(!0)):j(!0)}),[]),y=!!s.enabled;(0,o.useEffect)((()=>{!(0,N.availableNotifications)()||i.cluster!==l.CLUSTERS.mainnet||y||!h.isExtension&&location.pathname.includes("/provider")||!h.isExpandedView&&h.isExtension||I()}),[I,i.cluster,s.loading,y]);const k=()=>{const e=Date.now();g.default.solflareEnableNotificationsModal.set(e).then((()=>j(!1)))};return y||!_||S?null:(0,n.jsx)(c.WebPersistentBanner,{title:e("notifications_prompt_title"),message:e("notifications_prompt_text"),onClose:k,variant:"info",action:(0,n.jsx)(c.Button,{size:"s",variant:"contrast",onClick:()=>{x(!0),k()},children:e("notifications_prompt_enable")})})}},"../../libs/shared/dist/features/notifications/hooks/common/index.js":(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.useSetupNotifications=void 0;var s=i("../../libs/shared/dist/features/notifications/hooks/common/useSetupNotifications/index.js");Object.defineProperty(t,"useSetupNotifications",{enumerable:!0,get:function(){return s.useSetupNotifications}})},"../../libs/shared/dist/features/notifications/hooks/common/useSetupNotifications/index.js":(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.useSetupNotifications=void 0;const s=i("../../../node_modules/react/index.js"),n=i("../../../node_modules/react-redux/es/index.js"),o=i("../../../node_modules/firebase/app/dist/index.cjs.js"),a=i("../../libs/shared/dist/store/actions/notifications.js");t.useSetupNotifications=({enabled:e,onChange:t})=>{const i=(0,n.useDispatch)();(0,s.useEffect)((()=>{if(!e)return;let s;return(0,o.initializeApp)({apiKey:"AIzaSyBnuytdyhVuSzo0qAhX5QWYu6Z2jTBPWog",authDomain:"solflare-d0638.firebaseapp.com",projectId:"solflare-d0638",storageBucket:"solflare-d0638.appspot.com",messagingSenderId:"191112318129",appId:"1:191112318129:web:a3555b4ee54f13a6efa690"}),i((0,a.initializeNotifications)()),"permissions"in navigator&&navigator.permissions.query({name:"notifications"}).then((e=>{s=e,e.addEventListener("change",t)})),()=>{s&&s.removeEventListener("change",t)}}),[t,i,e])}},"../../libs/shared/dist/features/notifications/hooks/index.js":(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.useSetNotificationsEnabled=t.useRegisterNotifications=void 0;var s=i("../../libs/shared/dist/features/notifications/hooks/useRegisterNotifications/index.js");Object.defineProperty(t,"useRegisterNotifications",{enumerable:!0,get:function(){return s.useRegisterNotifications}});var n=i("../../libs/shared/dist/features/notifications/hooks/useSetNotificationsEnabled/index.js");Object.defineProperty(t,"useSetNotificationsEnabled",{enumerable:!0,get:function(){return n.useSetNotificationsEnabled}})},"../../libs/shared/dist/features/notifications/hooks/useRegisterNotifications/index.js":(e,t,i)=>{var s=i("../../../node_modules/console-browserify/index.js");Object.defineProperty(t,"__esModule",{value:!0}),t.useRegisterNotifications=void 0;const n=i("../../../node_modules/react/index.js"),o=i("../../../node_modules/react-i18next/dist/es/index.js"),a=i("../../../node_modules/react-redux/es/index.js"),r=i("../../../node_modules/firebase/messaging/dist/index.cjs.js"),d=i("../../../node_modules/reselect/es/index.js"),c=i("../../libs/shared/dist/constants/networks.js"),l=i("../../libs/shared/dist/store/actions/notifications.js"),u=i("../../libs/shared/dist/store/selectors/config.js"),f=i("../../libs/shared/dist/store/selectors/data.js"),p=i("../../libs/shared/dist/utils/extension.js"),g=i("../../libs/shared/dist/utils/notifications.js"),b=i("../../libs/shared/dist/features/notifications/hooks/common/index.js"),m=(0,d.createSelector)(u.walletDataSelector,(e=>{const{wallets:t,accounts:i,loggedIn:s}=e;return s?i.map((({name:e,publicKey:i})=>({name:e,publicKey:i,type:t[i].type}))):[]}));t.useRegisterNotifications=()=>{const{t:e,i18n:t}=(0,o.useTranslation)(),i=(0,a.useDispatch)(),{getState:d}=(0,a.useStore)(),h=(0,a.useSelector)(f.notificationsDataSelector),N=(0,a.useSelector)(u.networkSelector),_=(0,a.useSelector)(m),j=(0,n.useRef)(null),S=(0,n.useRef)(null),x=(0,n.useRef)(!1),I=N.cluster===c.CLUSTERS.mainnet,y=(0,g.availableNotifications)()&&I,k=(0,n.useCallback)((()=>{S.current&&j.current&&j.current.port.postMessage({id:`notification-permission-${Math.floor(Date.now()/2e3)}`,type:"NOTIFICATION_PERMISSION",portId:S.current})}),[]);(0,b.useSetupNotifications)({enabled:y,onChange:k});const E=(0,n.useCallback)((async e=>{if(!j.current)return;let t=null,i=null,s="/assets/logo-128.png";e.data.icon&&(s=e.data.icon),e.data&&(["notification","broadcast","cast","event"].includes(e.data.type)&&(t=e.data.title,i={body:e.data.body,icon:s,data:e.data}),j.current.port.postMessage({type:"NOTIFICATION",notificationId:e.data.uuid??e.messageId,notificationTitle:t,notificationOptions:i,portId:S.current}))}),[]),v=(0,n.useCallback)((async()=>{if(!j.current)return;const s=m(d());if("granted"===Notification.permission){const n=(0,r.getMessaging)(),o=await(0,r.getToken)(n,{vapidKey:"BJaqqoHkXBHpbb5TjC0jks2gmd6rEfFrDu9BBk89E7IaU6bvzD6BscmDf9ryfyfsmyH-c_e0aqEwX-86UD0VHII"});if(o)return x.current||((0,r.onMessage)(n,E),x.current=!0),await i((0,l.getRemoteDeviceState)({language:t.language,pushToken:o,osVersion:"1",accounts:s}))||j.current.port.postMessage({type:"NOTIFICATION",notificationId:`enabled-notifications-${Math.floor(Date.now()/2e3)}`,notificationTitle:e("notifications_enabled_title"),notificationOptions:{body:e("notifications_enabled_body"),icon:"/assets/logo-128.png"},portId:S.current}),void j.current.port.postMessage({type:"NOTIFICATION_RELOAD_STATE",portId:S.current})}await i((0,l.removeRemoteDeviceState)({language:t.language,keepPushToken:!0})),j.current.port.postMessage({type:"NOTIFICATION_RELOAD_STATE",portId:S.current})}),[i,d,E,t.language,e]),O=(0,n.useCallback)((e=>{"CONNECTION"===e.data.type?(S.current=e.data.portId,k()):"NOTIFICATION_PERMISSION"===e.data.type?v():"NOTIFICATION_RELOAD_STATE"===e.data.type?i((0,l.initializeNotificationsFromRemote)({language:t.language})):"NOTIFICATION"===e.data.type&&(new Notification(e.data.notificationTitle,e.data.notificationOptions).onclick=function(e){e.preventDefault(),e.target.close();const t=e.target.data,i=t?.publicKey;let n=null,o=null;try{if(t&&t.customPayload){const e=t.customPayload.match(/^([A-Za-z]+):(.*)$/);e&&e.length>=3&&(o=JSON.parse(e[2]),n=e[1])}}catch(e){s.log(e)}const a=p.isExtension?"/wallet.html#":"";let r=`${a}/portfolio`;const d=["source=notification"];let c=!p.isExtension&&window.location.pathname.startsWith("/provider")?"_blank":"_self";if(t&&o&&"CustomNotification"===n){const e=i?`/deeplink/${i}`:"";"dappBrowser"===o.redirect_page?(r=`${a}${e}/externallink`,d.push(`url=${encodeURIComponent(o.destination_url)}`),c="_blank"):"portfolioRoute"===o.redirect_page?r=`${a}${e}/portfolio`:"portfolioStakingRoute"===o.redirect_page?r=`${a}${e}/staking`:"tradingSwap"===o.redirect_page&&(r=`${a}${e}/trade`,o.destination_mint&&"So11111111111111111111111111111111111111112"!==o.destination_mint&&(d.push("from=So11111111111111111111111111111111111111112"),d.push(`to=${o.destination_mint}`))),o.campaign_id&&d.push(`campaign_id=${o.campaign_id}`),o.notification_id&&d.push(`notification_id=${o.notification_id}`)}else t&&i?(r=`${a}/deeplink/${i}/activity`,t.dappId&&(r=`${a}/deeplink/${i}/portfolio`,d.push(`msNotificationsCenter=${t.dappId}`))):t&&t.dappId&&(r=`${a}/portfolio`,d.push(`msNotificationsCenter=${t.dappId}`));d?.length>0&&(r+=`?${d.join("&")}`),window.open(r,c)})}),[k,i,v,t.language]);(0,n.useEffect)((()=>{if(y&&h.enabled&&null===j.current&&(!p.isExtension||!window.location.pathname.includes("confirm_popup.html")))return j.current=new SharedWorker("/notification-worker.js"),j.current.port.addEventListener("message",O),j.current.port.start(),()=>{j.current&&(j.current.port.removeEventListener("message",O),j.current.port.close(),j.current=null)}}),[y,O,h.enabled]),(0,n.useEffect)((()=>{j.current&&S.current&&k()}),[_,k])}},"../../libs/shared/dist/features/notifications/hooks/useSetNotificationsEnabled/index.js":(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.useSetNotificationsEnabled=t.openNotificationSettingsPage=void 0;const s=i("../../../node_modules/react/index.js"),n=i("../../../node_modules/react-i18next/dist/es/index.js"),o=i("../../../node_modules/react-redux/es/index.js"),a=i("../../libs/shared/dist/store/actions/notifications.js"),r=i("../../libs/shared/dist/utils/extension.js");t.openNotificationSettingsPage=()=>window.open("/wallet.html#/settings/notifications?enablePush=1","_blank"),t.useSetNotificationsEnabled=({onDenied:e}={})=>{const i=(0,o.useDispatch)(),{i18n:d}=(0,n.useTranslation)();return{setNotificationsEnabled:(0,s.useCallback)((async s=>{if("denied"===Notification.permission)return e?.();if("default"!==Notification.permission)await i((0,a.toggleNotificationsEnabled)({language:d.language,enabled:s}));else{if(r.isExtension&&!r.isExpandedView)return(0,t.openNotificationSettingsPage)();"granted"===await Notification.requestPermission()&&await i((0,a.toggleNotificationsEnabled)({language:d.language,enabled:s}))}}),[i,d.language,e])}}},"../../libs/shared/dist/features/notifications/index.js":(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.useSetNotificationsEnabled=t.useRegisterNotifications=void 0;var s=i("../../libs/shared/dist/features/notifications/hooks/index.js");Object.defineProperty(t,"useRegisterNotifications",{enumerable:!0,get:function(){return s.useRegisterNotifications}}),Object.defineProperty(t,"useSetNotificationsEnabled",{enumerable:!0,get:function(){return s.useSetNotificationsEnabled}})}}]);